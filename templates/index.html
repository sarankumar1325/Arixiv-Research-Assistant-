<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECT CHIMERA // RESEARCH TERMINAL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”¬</text></svg>">
</head>
<body>
    <div class="terminal-container">
        <div class="terminal-window">
            <div class="terminal-header">
                <div class="terminal-title">> PROJECT_CHIMERA.exe</div>
                <div class="terminal-status">
                    <span class="status-indicator">SYSTEM ONLINE</span>
                    <span id="clock">00:00:00</span>
                </div>
            </div>
            
            <div class="terminal-body">
                <div class="ascii-header">
                    <div class="logo-main">CHIMERA</div>
                    <div class="logo-sub">[ ACADEMIC RESEARCH SYNTHESIS SYSTEM ]</div>
                </div>

                <div class="boot-sequence" id="boot-sequence">
                    <div class="boot-line" style="animation-delay: 0.1s">> Initializing neural network interfaces...</div>
                    <div class="boot-line" style="animation-delay: 0.3s">> Loading Tavily search protocols...</div>
                    <div class="boot-line" style="animation-delay: 0.5s">> Establishing secure connection to academic databases...</div>
                    <div class="boot-line" style="animation-delay: 0.7s">> Calibrating synthesis algorithms...</div>
                    <div class="boot-line" style="animation-delay: 0.9s">> <span style="color: var(--status-success)">[OK]</span> System ready. Awaiting input.</div>
                </div>

                <form id="research-form">
                    <div class="command-line">
                        <span class="prompt">user@chimera:~$</span>
                        <div class="input-wrapper">
                            <input 
                                type="text" 
                                id="query" 
                                name="query" 
                                class="terminal-input"
                                placeholder="ENTER_RESEARCH_TOPIC"
                                required
                                autocomplete="off"
                            >
                            <span class="cursor"></span>
                        </div>
                    </div>
                    
                    <button type="submit" id="submit-btn" class="terminal-btn">
                        [ EXECUTE_RESEARCH ]
                    </button>
                </form>

                <div id="results"></div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 1rem; font-size: 0.75rem; color: var(--phosphor-dim); font-family: var(--font-terminal); letter-spacing: 2px;">
            v2.0.4 // BUILD 2026.02.02 // SECURE CONNECTION ESTABLISHED
        </div>
    </div>

    <script>
        // Clock
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('clock').textContent = timeString;
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Typewriter effect for input placeholder
        const placeholderTexts = [
            'ENTER_RESEARCH_TOPIC',
            'quantum_computing',
            'machine_learning',
            'climate_change',
            'neural_networks'
        ];
        let placeholderIndex = 0;
        let charIndex = 0;
        let isDeleting = false;
        const input = document.getElementById('query');

        function typePlaceholder() {
            const currentText = placeholderTexts[placeholderIndex];
            
            if (isDeleting) {
                input.placeholder = currentText.substring(0, charIndex - 1);
                charIndex--;
            } else {
                input.placeholder = currentText.substring(0, charIndex + 1);
                charIndex++;
            }

            let typeSpeed = isDeleting ? 50 : 100;

            if (!isDeleting && charIndex === currentText.length) {
                typeSpeed = 2000;
                isDeleting = true;
            } else if (isDeleting && charIndex === 0) {
                isDeleting = false;
                placeholderIndex = (placeholderIndex + 1) % placeholderTexts.length;
                typeSpeed = 500;
            }

            setTimeout(typePlaceholder, typeSpeed);
        }

        // Start typing effect after boot sequence
        setTimeout(typePlaceholder, 1500);

        // Form submission
        document.getElementById('research-form').addEventListener('submit', async function(event) {
            event.preventDefault();
            const query = event.target.elements.query.value.trim();
            const resultsDiv = document.getElementById('results');
            const submitBtn = document.getElementById('submit-btn');
            
            if (!query) return;
            
            // Disable input and button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '[ PROCESSING... ]';
            input.disabled = true;
            
            // Show loading state
            resultsDiv.innerHTML = `
                <div class="output-section">
                    <div class="output-header">EXECUTING_RESEARCH_PROTOCOL</div>
                    
                    <div class="loading-container">
                        <div class="loading-text">> ANALYZING: "${escapeHtml(query)}"</div>
                        <div class="loading-bar">
                            <div class="loading-bar-fill"></div>
                        </div>
                    </div>
                    
                    <div class="process-steps">
                        <div class="process-step active" id="step-search">
                            <div class="step-icon">[&#9632;]</div>
                            <div class="step-label">SEARCH</div>
                        </div>
                        <div class="process-step" id="step-analyze">
                            <div class="step-icon">[&#9632;]</div>
                            <div class="step-label">ANALYZE</div>
                        </div>
                        <div class="process-step" id="step-synthesize">
                            <div class="step-icon">[&#9632;]</div>
                            <div class="step-label">SYNTHESIZE</div>
                        </div>
                        <div class="process-step" id="step-generate">
                            <div class="step-icon">[&#9632;]</div>
                            <div class="step-label">GENERATE</div>
                        </div>
                    </div>
                    
                    <div id="terminal-logs" style="margin-top: 1.5rem; font-family: var(--font-mono); font-size: 0.75rem; color: var(--phosphor-dim); line-height: 1.8;">
                        <div>> Establishing connection to Tavily API...</div>
                    </div>
                </div>
            `;

            // Animate steps
            const steps = ['step-search', 'step-analyze', 'step-synthesize', 'step-generate'];
            const logs = [
                '> Querying academic databases...',
                '> Retrieving paper metadata...',
                '> Downloading source materials...',
                '> Extracting key findings...',
                '> Cross-referencing citations...',
                '> Synthesizing research insights...',
                '> Generating comprehensive report...',
                '> Formatting PDF output...'
            ];
            
            let currentStep = 0;
            let logIndex = 0;
            
            const stepInterval = setInterval(() => {
                if (currentStep < steps.length - 1) {
                    const currentEl = document.getElementById(steps[currentStep]);
                    if (currentEl) {
                        currentEl.classList.remove('active');
                        currentEl.classList.add('completed');
                    }
                    currentStep++;
                    const nextEl = document.getElementById(steps[currentStep]);
                    if (nextEl) {
                        nextEl.classList.add('active');
                    }
                }
            }, 4000);

            const logInterval = setInterval(() => {
                if (logIndex < logs.length) {
                    const logsDiv = document.getElementById('terminal-logs');
                    if (logsDiv) {
                        logsDiv.innerHTML += `<div style="animation: bootFade 0.3s forwards;">${logs[logIndex]}</div>`;
                        logsDiv.scrollTop = logsDiv.scrollHeight;
                    }
                    logIndex++;
                }
            }, 2500);

            try {
                const response = await fetch('/research', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `query=${encodeURIComponent(query)}`
                });
                
                clearInterval(stepInterval);
                clearInterval(logInterval);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Mark all steps as completed
                    steps.forEach(stepId => {
                        const el = document.getElementById(stepId);
                        if (el) {
                            el.classList.remove('active');
                            el.classList.add('completed');
                        }
                    });
                    
                    // Store data for PDF export
                    window.currentResearchData = {
                        query: data.query,
                        report_text: data.report_text,
                        paper_titles: data.paper_titles
                    };
                    
                    // Build results with report display
                    let html = `
                        <div class="output-section">
                            <div class="output-header">RESEARCH_PROTOCOL_COMPLETE</div>
                            
                            <div class="status-message success">
                                <strong>> OPERATION SUCCESSFUL</strong><br>
                                Retrieved ${data.paper_titles.length} relevant papers and synthesized comprehensive report.
                            </div>
                            
                            <div class="result-block">
                                <div class="result-header">> DISCOVERED_PAPERS</div>
                                <ul class="paper-list">
                    `;
                    
                    data.paper_titles.forEach((title, index) => {
                        html += `
                            <li class="paper-item">
                                <span class="paper-number">[${String(index + 1).padStart(2, '0')}]</span>
                                <span class="paper-title">${escapeHtml(title)}</span>
                            </li>
                        `;
                    });
                    
                    html += `
                                </ul>
                            </div>
                            
                            <div class="result-block">
                                <div class="result-header">> RESEARCH_REPORT</div>
                                <div class="report-content" id="report-content">
                                    ${formatReport(data.report_text)}
                                </div>
                            </div>
                            
                            <button type="button" id="export-btn" class="terminal-btn" onclick="exportToPDF()">
                                [ EXPORT_TO_PDF ]
                            </button>
                            
                            <div id="export-status"></div>
                        </div>
                    `;
                    
                    resultsDiv.innerHTML = html;
                } else {
                    resultsDiv.innerHTML = `
                        <div class="output-section">
                            <div class="output-header">SYSTEM_ERROR</div>
                            <div class="status-message error">
                                <strong>> OPERATION FAILED</strong><br>
                                ${escapeHtml(data.error || 'Unknown system error')}
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                clearInterval(stepInterval);
                clearInterval(logInterval);
                console.error('Fetch error:', error);
                resultsDiv.innerHTML = `
                    <div class="output-section">
                        <div class="output-header">CONNECTION_ERROR</div>
                        <div class="status-message error">
                            <strong>> CONNECTION TERMINATED</strong><br>
                            ${escapeHtml(error.message)}
                        </div>
                    </div>
                `;
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '[ EXECUTE_RESEARCH ]';
                input.disabled = false;
                input.focus();
            }
        });

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Format markdown report for terminal display
        function formatReport(reportText) {
            if (!reportText) return '<div class="report-line">No report content available.</div>';
            
            const lines = reportText.split('\n');
            let html = '';
            let inList = false;
            
            lines.forEach(line => {
                const trimmed = line.trim();
                
                if (trimmed.startsWith('# ')) {
                    // H1
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<div class="report-h1">${escapeHtml(trimmed.substring(2))}</div>`;
                } else if (trimmed.startsWith('## ')) {
                    // H2
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<div class="report-h2">${escapeHtml(trimmed.substring(3))}</div>`;
                } else if (trimmed.startsWith('### ')) {
                    // H3
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<div class="report-h3">${escapeHtml(trimmed.substring(4))}</div>`;
                } else if (trimmed.startsWith('- ') || trimmed.startsWith('* ')) {
                    // List item
                    if (!inList) { html += '<ul class="report-list">'; inList = true; }
                    html += `<li class="report-list-item">${escapeHtml(trimmed.substring(2))}</li>`;
                } else if (trimmed === '') {
                    // Empty line
                    if (inList) { html += '</ul>'; inList = false; }
                    html += '<div class="report-spacer"></div>';
                } else {
                    // Regular paragraph
                    if (inList) { html += '</ul>'; inList = false; }
                    html += `<div class="report-line">${escapeHtml(trimmed)}</div>`;
                }
            });
            
            if (inList) html += '</ul>';
            
            return html;
        }

        // Export to PDF function
        async function exportToPDF() {
            const exportBtn = document.getElementById('export-btn');
            const exportStatus = document.getElementById('export-status');
            
            if (!window.currentResearchData) {
                exportStatus.innerHTML = '<div class="status-message error"><strong>> ERROR</strong><br>No research data available.</div>';
                return;
            }
            
            exportBtn.disabled = true;
            exportBtn.innerHTML = '[ GENERATING_PDF... ]';
            exportStatus.innerHTML = '<div style="margin-top: 1rem; color: var(--phosphor-dim); font-size: 0.875rem;">> Processing PDF generation request...</div>';
            
            try {
                const response = await fetch('/export_pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: window.currentResearchData.query,
                        report_text: window.currentResearchData.report_text
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    exportStatus.innerHTML = `
                        <div class="status-message success" style="margin-top: 1rem;">
                            <strong>> PDF GENERATED SUCCESSFULLY</strong><br>
                            <a href="${data.download_url}" download="final_report.pdf" type="application/pdf" style="color: var(--accent-cyan); text-decoration: none; display: inline-block; margin-top: 0.5rem;">
                                [ CLICK_TO_DOWNLOAD ]
                            </a>
                        </div>
                    `;
                    exportBtn.innerHTML = '[ PDF_READY ]';
                } else {
                    throw new Error(data.error || 'PDF generation failed');
                }
            } catch (error) {
                exportStatus.innerHTML = `
                    <div class="status-message error" style="margin-top: 1rem;">
                        <strong>> PDF GENERATION FAILED</strong><br>
                        ${escapeHtml(error.message)}
                    </div>
                `;
                exportBtn.disabled = false;
                exportBtn.innerHTML = '[ RETRY_EXPORT ]';
            }
        }

        // Focus input on load
        window.addEventListener('load', () => {
            setTimeout(() => {
                input.focus();
            }, 2000);
        });
    </script>
</body>
</html>
